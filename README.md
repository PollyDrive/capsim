# CAPSIM 2.0 - Agent-based Discrete Event Simulation

‚ö° **–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π –º–µ–∂–¥—É –∞–≥–µ–Ω—Ç–∞–º–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ø—Ä–æ—Ñ–µ—Å—Å–∏–π –ø–æ–¥ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ–º —Ç—Ä–µ–Ω–¥–æ–≤, –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤.**

## ‚ö° –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```bash
# 1. –ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
git clone <repository-url>
cd capsim

# 2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
cp .env_example .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∏—Å—Ç–µ–º—É
docker-compose up -d

# 4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É
curl http://localhost:8000/healthz
```

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

CAPSIM 2.0 –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –º–æ–¥—É–ª—å–Ω–æ–π 4-—Å–ª–æ–π–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ:

- **API Layer** (FastAPI) - REST endpoints –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
- **Engine Layer** - SimulationEngine –∏ –æ—á–µ—Ä–µ–¥—å —Å–æ–±—ã—Ç–∏–π  
- **Domain Layer** - –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∞–≥–µ–Ω—Ç–æ–≤ –∏ —Ç—Ä–µ–Ω–¥–æ–≤
- **DB Layer** - –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º –∏ persistence

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

- **SimulationEngine** - —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä DES
- **Person** - –∞–≥–µ–Ω—Ç—ã —Å 12 —Ç–∏–ø–∞–º–∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–π
- **TrendProcessor** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º —Ç—Ä–µ–Ω–¥–æ–≤
- **PersonInfluence** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –≤–ª–∏—è–Ω–∏—è

## üéØ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

- **Python 3.11** - –æ—Å–Ω–æ–≤–Ω–æ–π —è–∑—ã–∫
- **FastAPI** - REST API framework
- **SQLAlchemy 2.0** - ORM –∏ —Ä–∞–±–æ—Ç–∞ —Å –ë–î
- **PostgreSQL 15** - –æ—Å–Ω–æ–≤–Ω–∞—è –°–£–ë–î
- **Alembic** - –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
- **Docker** - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è
- **Prometheus + Grafana** - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

## üìä –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

- **Throughput**: –¥–æ 43 —Å–æ–±—ã—Ç–∏–π –Ω–∞ –∞–≥–µ–Ω—Ç–∞ –≤ –¥–µ–Ω—å
- **Latency**: P95 < 10ms –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π
- **Scalability**: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–æ 5000 –∞–≥–µ–Ω—Ç–æ–≤
- **Queue Size**: –º–∞–∫—Å–∏–º—É–º 5000 —Å–æ–±—ã—Ç–∏–π –≤ –æ—á–µ—Ä–µ–¥–∏
- **Batch Commit**: –∫–∞–∂–¥—ã–µ 100 –æ–ø–µ—Ä–∞—Ü–∏–π –∏–ª–∏ 1 –º–∏–Ω—É—Ç—É

## üöÄ –û—Å–Ω–æ–≤–Ω—ã–µ endpoints

- **POST /api/v1/simulations** - —Å–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º—É–ª—è—Ü–∏–∏
- **GET /api/v1/simulations/{id}** - —Å—Ç–∞—Ç—É—Å —Å–∏–º—É–ª—è—Ü–∏–∏
- **GET /api/v1/simulations/{id}/agents** - —Å–ø–∏—Å–æ–∫ –∞–≥–µ–Ω—Ç–æ–≤
- **GET /api/v1/simulations/{id}/trends** - –∞–∫—Ç–∏–≤–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã
- **GET /healthz** - health check
- **GET /metrics** - Prometheus –º–µ—Ç—Ä–∏–∫–∏

## üîß –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
# Poetry (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
poetry install

# –ò–ª–∏ pip
pip install -r requirements.txt
```

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

```bash
# –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ –ë–î
docker-compose up postgres -d

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
export DATABASE_URL="postgresql://postgres:postgres_password@localhost:5432/capsim"

# –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
python -m capsim.api.main

# –ò–ª–∏ —á–µ—Ä–µ–∑ uvicorn
uvicorn capsim.api.main:app --reload --host 0.0.0.0 --port 8000
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
make test

# –ò–ª–∏ pytest –Ω–∞–ø—Ä—è–º—É—é
pytest tests/ -v

# –õ–∏–Ω—Ç–∏–Ω–≥ –∏ —Ç–∏–ø–∏–∑–∞—Ü–∏—è
make lint
```

### Makefile –∫–æ–º–∞–Ω–¥—ã

```bash
make dev-up      # –ó–∞–ø—É—Å–∫ –≤ dev —Ä–µ–∂–∏–º–µ
make dev-down    # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ dev –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
make test        # –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
make lint        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ (ruff + mypy)
make bootstrap   # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã
```

## üéÆ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º—É–ª—è—Ü–∏–∏

```bash
curl -X POST http://localhost:8000/api/v1/simulations \
  -H "Content-Type: application/json" \
  -d '{
    "num_agents": 1000,
    "duration_days": 7,
    "seed": 42
  }'
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞

```bash
curl http://localhost:8000/api/v1/simulations/{simulation_id}
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

- **Grafana**: http://localhost:3000 (admin/admin)
- **Prometheus**: http://localhost:9091
- **API Docs**: http://localhost:8000/docs

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏

### Prometheus –º–µ—Ç—Ä–∏–∫–∏

- `capsim_queue_length` - —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏ —Å–æ–±—ã—Ç–∏–π
- `capsim_event_latency_ms` - –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π
- `capsim_batch_commit_errors_total` - –æ—à–∏–±–∫–∏ batch commit
- `capsim_active_agents` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤
- `capsim_active_trends` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç—Ä–µ–Ω–¥–æ–≤

### –ê–ª–µ—Ä—Ç—ã

- **WARNING**: P95 latency > 10ms –≤ —Ç–µ—á–µ–Ω–∏–µ 3 –º–∏–Ω—É—Ç
- **CRITICAL**: Queue size > 5000 —Å–æ–±—ã—Ç–∏–π

## üóÉÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
capsim/
‚îú‚îÄ‚îÄ api/            # FastAPI routers –∏ endpoints
‚îú‚îÄ‚îÄ engine/         # SimulationEngine –∏ DES core
‚îú‚îÄ‚îÄ db/             # SQLAlchemy models –∏ repositories
‚îú‚îÄ‚îÄ domain/         # Domain objects (Person, Trend, Events)
‚îú‚îÄ‚îÄ common/         # –£—Ç–∏–ª–∏—Ç—ã, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îî‚îÄ‚îÄ cli/            # Command line interfaces

docs/
‚îú‚îÄ‚îÄ adr/            # Architecture Decision Records
‚îú‚îÄ‚îÄ diagrams/       # Mermaid –¥–∏–∞–≥—Ä–∞–º–º—ã
‚îú‚îÄ‚îÄ architecture_overview.md
‚îî‚îÄ‚îÄ events.md       # –ö–∞—Ç–∞–ª–æ–≥ —Å–æ–±—ã—Ç–∏–π

config/             # YAML –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
scripts/            # Bootstrap –∏ —É—Ç–∏–ª–∏—Ç—ã
monitoring/         # Prometheus –∏ Grafana –∫–æ–Ω—Ñ–∏–≥–∏
tests/              # –¢–µ—Å—Ç—ã
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

‚ö†Ô∏è **–í–ê–ñ–ù–û**: API –Ω–µ –∑–∞—â–∏—â–µ–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π. –°–µ—Ä–≤–∏—Å –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–µ—Ç–∏ –∏–ª–∏ VPN.

## üìù –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ `.env`:

```bash
# –°–∏–º—É–ª—è—Ü–∏—è
DECIDE_SCORE_THRESHOLD=0.25      # –ü–æ—Ä–æ–≥ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π
TREND_ARCHIVE_THRESHOLD_DAYS=3   # –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–µ–Ω–¥–æ–≤
BASE_RATE=43.2                   # –°–æ–±—ã—Ç–∏—è –≤ –¥–µ–Ω—å –Ω–∞ –∞–≥–µ–Ω—Ç–∞
BATCH_SIZE=100                   # –†–∞–∑–º–µ—Ä batch commit

# –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å  
SHUTDOWN_TIMEOUT_SEC=30          # –¢–∞–π–º–∞—É—Ç graceful shutdown
MAX_QUEUE_SIZE=5000              # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏
```

## ü§ù –£—á–∞—Å—Ç–∏–µ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ

1. –§–æ—Ä–∫–Ω–∏—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
2. –°–æ–∑–¥–∞–π—Ç–µ feature branch
3. –°–æ–±–ª—é–¥–∞–π—Ç–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –º–µ–∂–¥—É —Å–ª–æ—è–º–∏  
4. –î–æ–±–∞–≤—å—Ç–µ —Ç–µ—Å—Ç—ã –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞
5. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ CI –ø—Ä–æ—Ö–æ–¥–∏—Ç (ruff + mypy + pytest)
6. –°–æ–∑–¥–∞–π—Ç–µ Pull Request

## üìú –õ–∏—Ü–µ–Ω–∑–∏—è

Copyright (c) 2024 CAPSIM Team. All rights reserved.

---

## üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞

- **Issues**: GitHub Issues –¥–ª—è –±–∞–≥–æ–≤ –∏ feature requests
- **Documentation**: `/docs` –¥–ª—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- **API Docs**: `/docs` endpoint –∫–æ–≥–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ



