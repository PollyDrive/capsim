# CAPSIM Simulation Engine - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è Core Logic

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. DES-—Ü–∏–∫–ª (Discrete Event Simulation)

**–§–∞–π–ª**: `capsim/engine/simulation_engine.py`

–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª —Å–∏–º—É–ª—è—Ü–∏–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ –º–µ—Ç–æ–¥–µ `run_simulation()`:

- **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –æ—á–µ—Ä–µ–¥—å —Å–æ–±—ã—Ç–∏–π** —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `heapq`
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –ø–æ timestamp –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É** (1=LAW, 2=WEATHER, 3=TREND, 4=AGENT_ACTION, 5=SYSTEM)
- **–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –∞–≥–µ–Ω—Ç–æ–≤** –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç —Å–∏–º—É–ª—è—Ü–∏–∏
- **Batch-commit –º–µ—Ö–∞–Ω–∏–∑–º** –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø–∏—Å–∏ –≤ –ë–î
- **Graceful shutdown** —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

### 2. –õ–æ–≥–∏–∫–∞ –∞–≥–µ–Ω—Ç–æ–≤ (Person.decide_action)

**–§–∞–π–ª**: `capsim/domain/person.py`

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Ñ–æ—Ä–º—É–ª–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π:
```python
score = (0.5 * interest + 0.3 * social_status/5 + 0.2 * random) * affinity/5
```

- **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤**: —ç–Ω–µ—Ä–≥–∏—è > 1.0, time_budget > 0, trend_receptivity > 0
- **–í—ã–±–æ—Ä —Ç–µ–º—ã** –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ –∞–≥–µ–Ω—Ç–∞
- **Affinity mapping** –ø–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏—è–º (Banker, Developer, Teacher, Worker, ShopClerk)
- **–°–ª—É—á–∞–π–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä** –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç–∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è

### 3. –°–æ–±—ã—Ç–∏—è —Å–∏–º—É–ª—è—Ü–∏–∏

**–§–∞–π–ª**: `capsim/domain/events.py`

#### PublishPostAction
- –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç—Ä–µ–Ω–¥–æ–≤ —Å –±–∞–∑–æ–≤–æ–π –≤–∏—Ä–∞–ª—å–Ω–æ—Å—Ç—å—é
- –†–∞—Å—Ö–æ–¥ —ç–Ω–µ—Ä–≥–∏–∏ (-1.0) –∏ –≤—Ä–µ–º–µ–Ω–∏ (-1) –∞–≥–µ–Ω—Ç–∞
- –ü—Ä–∏—Ä–æ—Å—Ç —Å–æ—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ (+0.1)
- –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–ª–∏—è–Ω–∏—è —Ç—Ä–µ–Ω–¥–∞ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç

#### EnergyRecoveryEvent  
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏ –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤ (360 –º–∏–Ω—É—Ç)
- –ü–æ–ª–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ energy < 3.0, —á–∞—Å—Ç–∏—á–Ω–æ–µ (+2.0) –ø—Ä–∏ >= 3.0
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

#### –î—Ä—É–≥–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
- **DailyResetEvent**: —Å–±—Ä–æ—Å time_budget –ø–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏—è–º
- **SaveDailyTrendEvent**: –∞–≥—Ä–µ–≥–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ç—Ä–µ–Ω–¥–æ–≤
- **TrendInfluenceEvent**: —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –≤–ª–∏—è–Ω–∏—è —Ç—Ä–µ–Ω–¥–æ–≤

### 4. Virality Algorithm

**–§–∞–π–ª**: `capsim/domain/trend.py`

–§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞ –≤–∏—Ä–∞–ª—å–Ω–æ—Å—Ç–∏:
```python
new_score = min(5.0, base_virality + 0.05 * log(interactions + 1))
```

- **–õ–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–∏–π —Ä–æ—Å—Ç** –≤–∏—Ä–∞–ª—å–Ω–æ—Å—Ç–∏ –æ—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
- **Coverage levels**: Low (0.3), Middle (0.6), High (1.0)
- **–ë–∞–∑–æ–≤–∞—è –≤–∏—Ä–∞–ª—å–Ω–æ—Å—Ç—å** –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–æ—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Ä–∞
- **–ú–∞–∫—Å–∏–º—É–º 5.0** –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–æ—Å—Ç–∞

## üìä –î–µ–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç

```
üéÆ CAPSIM Simulation Engine - Demo Version
==================================================
üöÄ –°–∏–º—É–ª—è—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞: 20 –∞–≥–µ–Ω—Ç–æ–≤

üë• –ê–≥–µ–Ω—Ç—ã –ø–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏—è–º:
  Banker: 4, Developer: 4, Teacher: 4, Worker: 4, ShopClerk: 4

‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫ —Å–∏–º—É–ª—è—Ü–∏–∏ –Ω–∞ 0.083 –¥–Ω–µ–π (120.0 –º–∏–Ω—É—Ç)
üìù 59 –ø–æ—Å—Ç–æ–≤ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –∞–≥–µ–Ω—Ç–∞–º–∏
‚ö° –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏: 20 –∞–≥–µ–Ω—Ç–æ–≤

‚úÖ –°–∏–º—É–ª—è—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∑–∞ 360.0 –º–∏–Ω—É—Ç
üìä –°–æ–±—ã—Ç–∏—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: 748
üéØ –î–µ–π—Å—Ç–≤–∏–π –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ: 731  
üìà –¢—Ä–µ–Ω–¥–æ–≤ —Å–æ–∑–¥–∞–Ω–æ: 59

üéØ –¢–æ–ø —Ç—Ä–µ–Ω–¥–æ–≤ –ø–æ –≤–∏—Ä–∞–ª—å–Ω–æ—Å—Ç–∏:
  1. ENTERTAINMENT: –≤–∏—Ä–∞–ª—å–Ω–æ—Å—Ç—å 4.65
  2. EDUCATION: –≤–∏—Ä–∞–ª—å–Ω–æ—Å—Ç—å 4.61  
  3. ENTERTAINMENT: –≤–∏—Ä–∞–ª—å–Ω–æ—Å—Ç—å 4.55
```

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (ENV –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ)

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------|----------|
| `DECIDE_SCORE_THRESHOLD` | 0.25 | –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π score –¥–ª—è –¥–µ–π—Å—Ç–≤–∏—è |
| `BATCH_SIZE` | 100 | –†–∞–∑–º–µ—Ä batch –¥–ª—è commit |
| `BATCH_TIMEOUT_MIN` | 1.0 | –¢–∞–π–º–∞—É—Ç batch –≤ –º–∏–Ω—É—Ç–∞—Ö |
| `TREND_ARCHIVE_DAYS` | 3 | –î–Ω–∏ –¥–æ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ —Ç—Ä–µ–Ω–¥–æ–≤ |

## üöÄ –ó–∞–ø—É—Å–∫ —Å–∏–º—É–ª—è—Ü–∏–∏

### –î–µ–º–æ –≤–µ—Ä—Å–∏—è (–±–µ–∑ –ë–î)
```bash
python3 demo_simulation.py
```

### –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è (—Å –ë–î)
```bash
python3 -m capsim.cli.run_simulation --agents 100 --days 1
```

### –¢–µ—Å—Ç —Ä–µ–∂–∏–º
```bash  
python3 -m capsim.cli.run_simulation --test
```

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
1. **SimulationEngine** - —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä DES
2. **Person** - –∞–≥–µ–Ω—Ç—ã —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏  
3. **Trend** - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã —Å –≤–∏—Ä–∞–ª—å–Ω–æ—Å—Ç—å—é
4. **BaseEvent** - —Å–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏
5. **DatabaseRepository** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –ë–î

### –ü–∞—Ç—Ç–µ—Ä–Ω—ã
- **Event-driven architecture** –¥–ª—è DES-—Ü–∏–∫–ª–∞
- **Batch processing** –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ë–î
- **Strategy pattern** –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π
- **Repository pattern** –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- **P95 latency** < 10ms –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π
- **Batch commit** –∫–∞–∂–¥—ã–µ 100 –∑–∞–ø–∏—Å–µ–π –∏–ª–∏ 1 –º–∏–Ω—É—Ç—É —Å–∏–º—É–ª—è—Ü–∏–∏
- **Retry mechanism** —Å backoff (1s, 2s, 4s) –¥–ª—è –ë–î –æ–ø–µ—Ä–∞—Ü–∏–π
- **Graceful shutdown** —Å flush —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–§–∞–π–ª: `tests/test_simulation_engine.py`

- ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏–º—É–ª—è—Ü–∏–∏
- ‚úÖ –ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏–π –∞–≥–µ–Ω—Ç–∞–º–∏  
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π PublishPostAction
- ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏
- ‚úÖ –†–∞—Å—á–µ—Ç –≤–∏—Ä–∞–ª—å–Ω–æ—Å—Ç–∏ —Ç—Ä–µ–Ω–¥–æ–≤
- ‚úÖ Batch commit –º–µ—Ö–∞–Ω–∏–∑–º
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç —Å–∏–º—É–ª—è—Ü–∏–∏

## üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **PersonInfluence —Å–∏—Å—Ç–µ–º–∞** - —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –≤–ª–∏—è–Ω–∏—è –º–µ–∂–¥—É –∞–≥–µ–Ω—Ç–∞–º–∏
2. **–í–Ω–µ—à–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è** - Law/Weather —Å –≤–ª–∏—è–Ω–∏–µ–º –Ω–∞ –ø–æ–ø—É–ª—è—Ü–∏—é  
3. **–ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Prometheus
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ >10k –∞–≥–µ–Ω—Ç–æ–≤
5. **ML –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã** - –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ —Ç—Ä–µ–Ω–¥–æ–≤

---

‚úÖ **–û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ DES-—Å–∏–º—É–ª—è—Ü–∏–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞!** 