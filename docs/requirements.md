# CAPSIM 2.0 - –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

## üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø

### 1. –ï–î–ò–ù–°–¢–í–ï–ù–ù–ê–Ø –ê–ö–¢–ò–í–ù–ê–Ø –°–ò–ú–£–õ–Ø–¶–ò–Ø

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ**: –°–∏—Å—Ç–µ–º–∞ **–ù–ï –î–û–õ–ñ–ù–ê** –∑–∞–ø—É—Å–∫–∞—Ç—å –±–æ–ª–µ–µ –æ–¥–Ω–æ–π —Å–∏–º—É–ª—è—Ü–∏–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.

#### –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ
- **–¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö**: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —Å–∏–º—É–ª—è—Ü–∏–∏ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –≤ –ë–î
- **–†–µ—Å—É—Ä—Å—ã —Å–∏—Å—Ç–µ–º—ã**: –°–∏–º—É–ª—è—Ü–∏—è —Å 1000+ –∞–≥–µ–Ω—Ç–∞–º–∏ —Ç—Ä–µ–±—É–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã—Ö –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
- **–î–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º**: –ì–∞—Ä–∞–Ω—Ç–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –£–ø—Ä–æ—â–µ–Ω–∏–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

#### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ:**
```python
# –í capsim/engine/simulation_engine.py::initialize()
active_simulations = await self.db_repo.get_active_simulations()
if active_simulations:
    raise RuntimeError("–ê–∫—Ç–∏–≤–Ω–∞—è —Å–∏–º—É–ª—è—Ü–∏—è —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞!")
```

**–°—Ç–∞—Ç—É—Å—ã —Å–∏–º—É–ª—è—Ü–∏–π:**
- `RUNNING` - –∞–∫—Ç–∏–≤–Ω–∞—è —Å–∏–º—É–ª—è—Ü–∏—è
- `STOPPING` - –ø—Ä–æ—Ü–µ—Å—Å –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
- `COMPLETED` - –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ
- `FAILED` - –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —Å –æ—à–∏–±–∫–æ–π
- `FORCE_STOPPED` - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞

#### CLI –∫–æ–º–∞–Ω–¥—ã

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:**
```bash
python -m capsim status
```

**–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–∏–º—É–ª—è—Ü–∏–∏:**
```bash
# Graceful –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
python -m capsim stop [simulation_id]

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
python -m capsim stop [simulation_id] --force
```

**–ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–π —Å–∏–º—É–ª—è—Ü–∏–∏:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–∏–º—É–ª—è—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
python -m capsim run --agents 100 --days 1
```

#### –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–∏

–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–ø—É—Å–∫–∞ –≤—Ç–æ—Ä–æ–π —Å–∏–º—É–ª—è—Ü–∏–∏:

1. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: WARNING —Å ID –∞–∫—Ç–∏–≤–Ω–æ–π —Å–∏–º—É–ª—è—Ü–∏–∏
2. **–ò—Å–∫–ª—é—á–µ–Ω–∏–µ**: `RuntimeError` —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
3. **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**: –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏/–ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞

–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:
```
‚ùå –û–¢–ö–õ–û–ù–ï–ù–û: –ê–∫—Ç–∏–≤–Ω–∞—è —Å–∏–º—É–ª—è—Ü–∏—è —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞!
üîÑ ID: 2ed1315b-17a1-4b05-bdbc-11187f8270d5
üìä –°—Ç–∞—Ç—É—Å: RUNNING
üë• –ê–≥–µ–Ω—Ç–æ–≤: 30
‚è∞ –ó–∞–ø—É—â–µ–Ω–∞: 2025-06-25 13:10:04

üí° –î–ª—è –∑–∞–ø—É—Å–∫–∞ –Ω–æ–≤–æ–π —Å–∏–º—É–ª—è—Ü–∏–∏:
   1. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π —Å–∏–º—É–ª—è—Ü–∏–∏
   2. –ò–ª–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: python -m capsim stop 2ed1315b-17a1-4b05-bdbc-11187f8270d5
   3. –ó–∞—Ç–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç–µ –Ω–æ–≤—É—é —Å–∏–º—É–ª—è—Ü–∏—é
```

---

## üîß –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø

### 2. –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –°–ò–ú–£–õ–Ø–¶–ò–ò

#### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **PostgreSQL 15+** –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
- **–°—Ö–µ–º–∞**: `capsim` (–≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ö–µ–º–µ)
- **–î—Ä–∞–π–≤–µ—Ä**: `asyncpg` –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è**: read-write + read-only —Å–µ—Å—Å–∏–∏

#### –¢–∞–±–ª–∏—Ü—ã
- `simulation_runs` - –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–∏–º—É–ª—è—Ü–∏–π
- `persons` - –∞–≥–µ–Ω—Ç—ã —Å–∏–º—É–ª—è—Ü–∏–∏
- `trends` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã
- `events` - –∏—Å—Ç–æ—Ä–∏—è —Å–æ–±—ã—Ç–∏–π
- `affinity_map` - –º–∞—Ç—Ä–∏—Ü–∞ —Å–∫–ª–æ–Ω–Ω–æ—Å—Ç–µ–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–π

### 3. –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨

#### –í—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
- **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è**: ‚â§ 10 —Å–µ–∫—É–Ω–¥ –¥–ª—è 1000 –∞–≥–µ–Ω—Ç–æ–≤
- **Event latency**: ‚â§ 10ms P95 –≤ fast-—Ä–µ–∂–∏–º–µ
- **Batch commit**: –∫–∞–∂–¥—ã–µ 100 –æ–ø–µ—Ä–∞—Ü–∏–π –ò–õ–ò 60 —Å–µ–∫—É–Ω–¥
- **Graceful shutdown**: ‚â§ 30 —Å–µ–∫—É–Ω–¥

#### –†–µ—Å—É—Ä—Å—ã
- **–ü–∞–º—è—Ç—å**: ‚â§ 1GB –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏ 1000 –∞–≥–µ–Ω—Ç–æ–≤
- **CPU**: ‚â§ 75% –æ–¥–Ω–æ–≥–æ —è–¥—Ä–∞ –≤ realtime-—Ä–µ–∂–∏–º–µ
- **–î–∏—Å–∫**: ‚â§ 100MB/—á–∞—Å –ª–æ–≥–æ–≤ –∏ —Å–æ–±—ã—Ç–∏–π

### 4. –†–ï–ñ–ò–ú–´ –†–ê–ë–û–¢–´

#### Fast Mode (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
```bash
SIM_SPEED_FACTOR=60  # 1 —Å–∏–º-–º–∏–Ω—É—Ç–∞ = 1 —Ä–µ–∞–ª—å–Ω–∞—è —Å–µ–∫—É–Ω–¥–∞
```

#### Realtime Mode
```bash
SIM_SPEED_FACTOR=1   # 1 —Å–∏–º-–º–∏–Ω—É—Ç–∞ = 1 —Ä–µ–∞–ª—å–Ω–∞—è –º–∏–Ω—É—Ç–∞
```

#### Development Mode
```bash
SIM_SPEED_FACTOR=3600  # 1 —Å–∏–º-–º–∏–Ω—É—Ç–∞ = 1–º—Å (–¥–ª—è —Ç–µ—Å—Ç–æ–≤)
```

---

## üö® –ú–û–ù–ò–¢–û–†–ò–ù–ì –ò –ê–õ–ï–†–¢–´

### 5. –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ú–ï–¢–†–ò–ö–ò

#### Prometheus –º–µ—Ç—Ä–∏–∫–∏
- `capsim_active_simulations_total` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–∏–º—É–ª—è—Ü–∏–π
- `capsim_event_latency_ms` - –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π
- `capsim_queue_length` - —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏ —Å–æ–±—ã—Ç–∏–π
- `capsim_agents_total` - –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–≥–µ–Ω—Ç–æ–≤

#### –ê–ª–µ—Ä—Ç—ã Grafana

**CRITICAL**: –ù–∞—Ä—É—à–µ–Ω–∏–µ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ —Å–∏–º—É–ª—è—Ü–∏–∏
```yaml
- alert: MultipleActiveSimulations
  expr: capsim_active_simulations_total > 1
  for: 0s
  annotations:
    summary: "–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ {{ $value }} –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–∏–º—É–ª—è—Ü–∏–π!"
```

**WARNING**: –í—ã—Å–æ–∫–∞—è –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
```yaml
- alert: HighEventLatency
  expr: histogram_quantile(0.95, capsim_event_latency_ms_bucket) > 10
  for: 3m
  annotations:
    summary: "–õ–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Å–æ–±—ã—Ç–∏–π: {{ $value }}ms"
```

**WARNING**: –ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏
```yaml
- alert: QueueOverflow  
  expr: capsim_queue_length > 5000
  for: 1m
  annotations:
    summary: "–û—á–µ—Ä–µ–¥—å —Å–æ–±—ã—Ç–∏–π: {{ $value }} —ç–ª–µ–º–µ–Ω—Ç–æ–≤"
```

### 6. –õ–û–ì–ò–†–û–í–ê–ù–ò–ï

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ª–æ–≥–æ–≤
```json
{
  "timestamp": "2025-06-25T13:10:04.123Z",
  "level": "INFO",
  "event": "simulation_rejected_active_exists",
  "active_simulation_id": "uuid",
  "active_status": "RUNNING",
  "total_active_simulations": 1
}
```

#### –ö–ª—é—á–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è
- `simulation_initializing` - –Ω–∞—á–∞–ª–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
- `simulation_rejected_active_exists` - –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∏–∑-–∑–∞ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–∏–º—É–ª—è—Ü–∏–∏
- `simulation_started` - —Å–∏–º—É–ª—è—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞
- `simulation_completed` - —Å–∏–º—É–ª—è—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞
- `simulation_force_stopped` - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞

---

## üìã –û–ü–ï–†–ê–¶–ò–û–ù–ù–´–ï –ü–†–û–¶–ï–î–£–†–´

### 7. –≠–ö–°–¢–†–ï–ù–ù–´–ï –°–ò–¢–£–ê–¶–ò–ò

#### –ó–∞–≤–∏—Å—à–∞—è —Å–∏–º—É–ª—è—Ü–∏—è
```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
python -m capsim status

# 2. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
python -m capsim stop --force

# 3. –û—á–∏—Å—Ç–∫–∞ –ë–î (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
docker exec capsim-postgres-1 psql -U postgres -d capsim_db -c \
  "UPDATE capsim.simulation_runs SET status='FORCE_STOPPED', end_time=NOW() WHERE end_time IS NULL;"
```

#### –ü—Ä–æ–±–ª–µ–º—ã —Å –ë–î
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
docker exec capsim-postgres-1 psql -U postgres -d capsim_db -c "SELECT 1;"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–∏–º—É–ª—è—Ü–∏–π
docker exec capsim-postgres-1 psql -U postgres -d capsim_db -c \
  "SELECT run_id, status, start_time, num_agents FROM capsim.simulation_runs WHERE end_time IS NULL;"
```

### 8. –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï

#### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –æ–∫—Ä—É–∂–µ–Ω–∏—é
- Docker Compose —Å —Å–µ—Ä–≤–∏—Å–∞–º–∏: `app`, `postgres`, `prometheus`, `grafana`
- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ `.env` —Ñ–∞–π–ª–µ
- –°–µ—Ç–µ–≤—ã–µ –ø–æ—Ä—Ç—ã: `8000` (API), `5432` (PostgreSQL), `9090` (Prometheus), `3000` (Grafana)

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
```bash
# Healthcheck
curl localhost:8000/healthz

# –°—Ç–∞—Ç—É—Å —Å–∏–º—É–ª—è—Ü–∏–π
python -m capsim status

# –ú–µ—Ç—Ä–∏–∫–∏
curl localhost:9090/api/v1/query?query=capsim_active_simulations_total
```

---

## ‚ö†Ô∏è –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–Ø

### 9. –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø

- ‚ùå **–ù–ï** –∑–∞–ø—É—Å–∫–∞–π—Ç–µ —Å–∏–º—É–ª—è—Ü–∏–∏ –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ API –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
- ‚ùå **–ù–ï** –∏–∑–º–µ–Ω—è–π—Ç–µ —Å—Ç–∞—Ç—É—Å —Å–∏–º—É–ª—è—Ü–∏–π –≤—Ä—É—á–Ω—É—é –≤ –ë–î –±–µ–∑ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- ‚ùå **–ù–ï** —É–¥–∞–ª—è–π—Ç–µ –∑–∞–ø–∏—Å–∏ –∏–∑ `simulation_runs` –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- ‚ö†Ô∏è **–í–°–ï–ì–î–ê** –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ graceful –æ—Å—Ç–∞–Ω–æ–≤–∫—É –ø–µ—Ä–µ–¥ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π
- ‚ö†Ô∏è **–ü–†–û–í–ï–†–Ø–ô–¢–ï** —Å—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –Ω–æ–≤–æ–π —Å–∏–º—É–ª—è—Ü–∏–∏

### 10. –ò–ó–í–ï–°–¢–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

- –ü—Ä–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å—Ç–∞—Ç—É—Å –º–æ–∂–µ—Ç –æ—Å—Ç–∞—Ç—å—Å—è `RUNNING`
- –í Docker –º–æ–≥—É—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å SIGTERM –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
- PostgreSQL —Ç—Ä–µ–±—É–µ—Ç –≤—Ä–µ–º—è –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

---

**–î–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞**: 2025-06-25  
**–í–µ—Ä—Å–∏—è**: 1.0  
**–ê–≤—Ç–æ—Ä**: –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä CAPSIM 2.0 