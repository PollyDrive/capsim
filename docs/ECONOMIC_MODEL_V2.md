# CAPSIM 2.0 - Спецификация экономической модели

## Обзор

Данный документ описывает новую экономическую модель CAPSIM v2.0, разработанную для решения проблемы дисбаланса атрибутов агентов. Модель обеспечивает реалистичную динамику ресурсов с профессиональной дифференциацией.

## Выявленные проблемы в v1.9

1. **Универсальная потеря финансовых возможностей**: все профессии показывают отрицательную динамику от -1.19 до -4.35
2. **Нереалистичный рост энергии**: 100% агентов увеличивают энергию (+0.45 до +1.82)
3. **Универсальная потеря времени**: все агенты теряют временной бюджет (-0.1 до -3.1)
4. **Отсутствие профессиональной дифференциации** в паттернах изменений атрибутов

## Архитектура новой модели

### 1. Система доходов

#### Базовый профессиональный доход
```
базовый_доход = initial_financial_capability × profession_coefficient
```

#### Коэффициенты по профессиям
```yaml
INCOME_COEFFICIENTS:
  Unemployed: 0.0        # Отсутствие дохода
  Student: 0.2           # Стипендия/подработка
  Artist: 0.5            # Низкий нерегулярный доход
  Teacher: 0.6           # Низкий стабильный доход
  SpiritualMentor: 0.6   # Пожертвования
  Philosopher: 0.7       # Академический доход
  ShopClerk: 0.8         # Средний доход
  Worker: 0.8            # Рабочий доход
  Developer: 1.0         # Хороший доход
  Doctor: 1.1            # Высокий доход
  Blogger: 1.2           # Доход от контента
  Businessman: 1.3       # Высокий бизнес-доход
  Politician: 1.5        # Максимальный доход
```

#### Бонус за социальный статус
```
status_bonus = базовый_доход × (social_status / 5.0)
итоговый_доход = базовый_доход + status_bonus
```

**Условия начисления:**
- В конце дня при положительной динамике социального статуса
- Только если агент был активен в течение дня

### 2. Система расходов

#### Обязательные расходы (базовые потребности)
```yaml
DAILY_EXPENSES:
  Unemployed: 0.5        # Минимальные потребности
  Student: 0.8           # Учебные расходы
  Artist: 1.0            # Материалы для творчества
  Teacher: 1.2           # Профессиональные расходы
  SpiritualMentor: 1.0   # Скромные потребности
  Philosopher: 1.1       # Книги, исследования
  ShopClerk: 1.5         # Средние потребности
  Worker: 1.8            # Рабочие расходы
  Developer: 2.0         # Техника, обучение
  Doctor: 2.2            # Высокие стандарты жизни
  Blogger: 1.8           # Оборудование, контент
  Businessman: 2.5       # Представительские расходы
  Politician: 3.0        # Максимальные расходы
```

**Принципы:**
- Автоматическое списание в конце дня
- Без налогов и штрафов (упрощение модели)
- Пропорционально доходам профессии

### 3. Энергетическая модель

#### Базовые траты энергии
```yaml
ENERGY_COSTS:
  base_activity: 0.3     # Базовая трата за любое действие
  stress_actions: 0.5    # Споры, негативные посты
  post_action: 0.2       # Дополнительно к базовой
  purchase_action: 0.1   # Минимальная трата на покупки
  selfdev_action: 0.4    # Умственная нагрузка
```

#### Восстановление энергии
- **Покупки L1/L2/L3**: сохранить текущие значения из actions.yaml
- **Саморазвитие**: сохранить текущие значения
- **Ночное восстановление**: базовое восстановление + бонус

### 4. Система времени

#### Дневное время (08:00-24:00)
```yaml
TIME_COSTS:
  simple_actions: [5, 15]    # Лайки, комментарии (минуты)
  complex_actions: [30, 60]  # Создание контента, покупки
  post_action: 15            # Время на пост
  purchase_action: 10        # Время на покупку
  selfdev_action: 80         # Время на саморазвитие
```

#### Ночное восстановление (00:00-08:00)
- **Полное восстановление** time_budget до максимума профессии
- Агенты неактивны (20% активности для реализма)

### 5. Система социального статуса

#### Рост статуса
```yaml
STATUS_GAINS:
  expensive_purchases:
    L2: 0.1                  # Средние покупки
    L3: 0.2                  # Дорогие покупки
    diminishing_returns: 0.8 # Убывающая отдача от частых покупок
  
  quality_content:
    high_engagement: 0.4     # Популярный контент
    medium_engagement: 0.2   # Средний контент
    low_engagement: 0.1      # Базовый контент
  
  positive_posts: 0.2        # Позитивные посты
```

#### Снижение статуса
```yaml
STATUS_LOSSES:
  negative_content: -0.3     # Негативный контент
  controversial_posts: -0.2  # Спорные посты
  inactivity_penalty: -0.05  # Штраф за неактивность (еженедельно)
```

### 6. Ночной цикл восстановления

#### Алгоритм ночного восстановления (00:00)
```python
def night_recovery(agent):
    # 1. Восстановление времени
    agent.time_budget = get_max_time_budget(agent.profession)
    
    # 2. Восстановление энергии
    energy_recovery = NIGHT_RECOVERY.energy_bonus * (5.0 - agent.energy_level)
    agent.energy_level = min(5.0, agent.energy_level + energy_recovery)
    
    # 3. Начисление дохода (если был рост социального статуса)
    if agent.social_status_delta > 0:
        income = calculate_daily_income(agent)
        agent.financial_capability += income
    
    # 4. Списание обязательных расходов
    expenses = DAILY_EXPENSES[agent.profession]
    agent.financial_capability = max(0.0, agent.financial_capability - expenses)
    
    # 5. Сброс дневных счетчиков
    agent.purchases_today = 0
    agent.actions_today = 0
    agent.social_status_delta = 0
```

## Конфигурационные файлы

### economic_balance.yaml
Новый файл с параметрами экономической модели:
```yaml
INCOME_COEFFICIENTS: {...}
DAILY_EXPENSES: {...}
ENERGY_COSTS: {...}
TIME_COSTS: {...}
STATUS_GAINS: {...}
STATUS_LOSSES: {...}
NIGHT_RECOVERY: {...}
```

### Обновления actions.yaml
Добавление новых параметров трат энергии:
```yaml
ENERGY_COSTS:
  base_activity: 0.3
  stress_actions: 0.5
  # ... остальные параметры
```

## Ожидаемые результаты

### Реалистичная динамика атрибутов
1. **Financial capability**: 
   - Рост у высокооплачиваемых профессий
   - Стабильность у средних профессий
   - Медленное снижение у безработных

2. **Energy level**:
   - Циклическое восстановление ночью
   - Реалистичные траты в течение дня
   - Баланс между активностью и отдыхом

3. **Time budget**:
   - Полное восстановление каждую ночь
   - Реалистичные траты на действия
   - Профессиональная дифференциация

4. **Social status**:
   - Рост от качественной активности
   - Убывающая отдача от повторных действий
   - Штрафы за негативное поведение

### Профессиональная дифференциация
- **Политики/Бизнесмены**: высокие доходы, высокие расходы
- **Разработчики/Врачи**: стабильные доходы, умеренные расходы
- **Учителя/Художники**: низкие доходы, низкие расходы
- **Безработные**: отсутствие доходов, минимальные расходы

## Совместимость и миграция

### Обратная совместимость
- Сохранение всех существующих полей БД
- Аддитивные изменения в коде
- Конфигурируемость через YAML файлы

### План миграции
1. Добавление новых конфигурационных файлов
2. Расширение логики обработки событий
3. Добавление ночного цикла восстановления
4. Тестирование на малых симуляциях
5. Постепенное внедрение в продакшн

## Мониторинг и метрики

### Новые метрики
```yaml
economic_balance_metrics:
  - avg_financial_capability_by_profession
  - daily_income_distribution
  - daily_expenses_distribution
  - energy_recovery_efficiency
  - social_status_dynamics
  - night_recovery_success_rate
```

### Алерты
- Критическое снижение финансовых возможностей
- Аномальный рост/падение энергии
- Дисбаланс доходов/расходов по профессиям

## Заключение

Экономическая модель v2.0 решает все выявленные проблемы дисбаланса атрибутов и создает реалистичную, устойчивую систему ресурсов агентов с профессиональной дифференциацией. Модель полностью совместима с существующей архитектурой и может быть внедрена поэтапно.